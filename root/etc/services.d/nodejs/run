#!/usr/bin/execlineb -P

with-contenv

importas -u NODE_ENV NODE_ENV

backtick -i -n DEFAULT_TARGET {
  ifelse { s6-test "${NODE_ENV}" = "production" }
  {
    s6-echo -- "start"
  }

  ifelse { s6-test "${NODE_ENV}" = "development" }
  {
    s6-echo -- "dev"
  }

  if { s6-test "${NODE_ENV}" = "test" }
  {
    s6-echo -- "test"
  }

  s6-echo -- ""
}
importas -u DEFAULT_TARGET DEFAULT_TARGET

importas -u -D "${DEFAULT_TARGET}" TARGET TARGET

ifelse { s6-test "${TARGET}" = "" }
{
  foreground { s6-echo -- "Empty target not supported. Are you missing environment variable TARGET or NODE_ENV?" }
  exit 1
}
foreground {
  s6-echo -- "Running 'npm run ${TARGET}'"
}
cd "/app"
s6-env HOME=/home/node
s6-setuidgid node
npm run ${TARGET}
